{% extends 'base.html' %}

{% block title %}–ö–∞—Ä—Ç–∞ –ü—É—Å—Ç–æ—à–µ–π{% endblock %}

{% block content %}
<h2 style="text-align: center; margin-bottom: 20px;">üó∫ –ö–ê–†–¢–ê –ü–£–°–¢–û–®–ï–ô üó∫</h2>

<div class="search-form">
    <input type="number" id="search-lat" placeholder="–®–∏—Ä–æ—Ç–∞" step="0.000001">
    <input type="number" id="search-lon" placeholder="–î–æ–ª–≥–æ—Ç–∞" step="0.000001">
    <input type="number" id="search-radius" placeholder="–†–∞–¥–∏—É—Å (–∫–º)" value="10">
    <button class="btn" onclick="searchPoints()">–ü–û–ò–°–ö</button>
</div>

<div id="map"></div>

<div id="results" style="margin-top: 20px;"></div>
{% endblock %}

{% block extra_js %}
<script>
    const map = L.map('map').setView([55.7558, 37.6173], 10);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
    }).addTo(map);

    const markers = [];

    async function loadPoints() {
        try {
            const response = await fetch('/api/points/', {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                }
            });
            const data = await response.json();
            
            data.results.forEach(point => {
                const [lon, lat] = point.location.coordinates;
                const marker = L.marker([lat, lon]).addTo(map);
                marker.bindPopup(`<b>${point.title}</b><br>${point.description || ''}`);
                markers.push(marker);
            });
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ—á–µ–∫:', error);
        }
    }

    async function searchPoints() {
        const lat = document.getElementById('search-lat').value;
        const lon = document.getElementById('search-lon').value;
        const radius = document.getElementById('search-radius').value;

        if (!lat || !lon || !radius) {
            alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
            return;
        }

        try {
            const response = await fetch(
                `/api/points/search/?latitude=${lat}&longitude=${lon}&radius=${radius}`,
                {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                    }
                }
            );
            const points = await response.json();
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<h3>–ù–∞–π–¥–µ–Ω–æ —Ç–æ—á–µ–∫: ' + points.length + '</h3>';
            
            points.forEach(point => {
                resultsDiv.innerHTML += `
                    <div class="point-card">
                        <h3>${point.title}</h3>
                        <p>${point.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                        <p>–í–ª–∞–¥–µ–ª–µ—Ü: ${point.owner_display_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}</p>
                    </div>
                `;
            });
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
        }
    }

    loadPoints();
</script>
{% endblock %}
