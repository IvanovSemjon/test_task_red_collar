{% extends 'base.html' %}

{% block title %}–ö–∞—Ä—Ç–∞ –ü—É—Å—Ç–æ—à–µ–π{% endblock %}

{% block content %}
<h2 style="text-align: center; margin-bottom: 20px;">üó∫ –ö–ê–†–¢–ê –ü–£–°–¢–û–®–ï–ô üó∫</h2>

<div class="search-form">
    <input type="number" id="search-lat" placeholder="–®–∏—Ä–æ—Ç–∞" step="0.000001">
    <input type="number" id="search-lon" placeholder="–î–æ–ª–≥–æ—Ç–∞" step="0.000001">
    <input type="number" id="search-radius" placeholder="–†–∞–¥–∏—É—Å (–∫–º)" value="10">
    <button class="btn" onclick="searchPoints()">–ü–û–ò–°–ö</button>
    <button class="btn" onclick="getCurrentLocation()">üìç –ú–û–Ø –ü–û–ó–ò–¶–ò–Ø</button>
</div>

<div id="map"></div>

<div id="results" style="margin-top: 20px;"></div>
{% endblock %}

{% block extra_js %}
<script>
    const map = L.map('map').setView([55.7558, 37.6173], 10);
    
    // –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –∫–∞—Ä—Ç—ã –¥–ª—è –ø–æ—Å—Ç–∞–ø–æ–∫–∞–ª–∏–ø—Å–∏—Å–∞
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '¬© OpenStreetMap ¬© CartoDB',
        subdomains: 'abcd',
        maxZoom: 19
    }).addTo(map);

    const markers = [];
    let userMarker = null;
    let searchCircle = null;

    // –ö–∞—Å—Ç–æ–º–Ω–∞—è –∏–∫–æ–Ω–∫–∞ –¥–ª—è —Ç–æ—á–µ–∫
    const pointIcon = L.icon({
        iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCAzMCA0MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTUgMEMxMC4wMyAwIDYgNC4wMyA2IDlDNiAxNC4yNSAxNSAyNSAxNSAyNUMxNSAyNSAyNCAxNC4yNSAyNCA5QzI0IDQuMDMgMTkuOTcgMCAxNSAwWiIgZmlsbD0iIzAwZmYwMCIgc3Ryb2tlPSIjMDA4ODAwIiBzdHJva2Utd2lkdGg9IjIiLz48Y2lyY2xlIGN4PSIxNSIgY3k9IjkiIHI9IjQiIGZpbGw9IiMwMDg4MDAiLz48L3N2Zz4=',
        iconSize: [30, 40],
        iconAnchor: [15, 40],
        popupAnchor: [0, -40]
    });

    async function loadPoints() {
        const token = localStorage.getItem('access_token');
        if (!token) {
            showAuthWarning();
            return;
        }
        
        try {
            const response = await fetch('/api/points/', {
                headers: {'Authorization': 'Bearer ' + token}
            });
            
            if (!response.ok) {
                console.error('HTTP error:', response.status);
                showAuthWarning();
                return;
            }
            
            const data = await response.json();
            console.log('Received data:', data);
            
            // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤
            if (markers && markers.length > 0) {
                markers.forEach(m => map.removeLayer(m));
                markers.length = 0;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è results
            if (!data || !data.results) {
                console.error('No results in response');
                showAuthWarning();
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ results —ç—Ç–æ –º–∞—Å—Å–∏–≤
            if (!Array.isArray(data.results)) {
                console.error('Results is not an array:', typeof data.results);
                showAuthWarning();
                return;
            }
            
            console.log('Points count:', data.results.length);
            
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤
            for (let i = 0; i < data.results.length; i++) {
                const point = data.results[i];
                console.log('Processing point:', i, point);
                
                if (!point.location) {
                    console.log('Point has no location:', i);
                    continue;
                }
                
                if (!point.location.coordinates) {
                    console.log('Point has no coordinates:', i);
                    continue;
                }
                
                const [lon, lat] = point.location.coordinates;
                console.log('Coordinates:', lat, lon);
                
                const marker = L.marker([lat, lon], {icon: pointIcon}).addTo(map);
                
                const popupContent = `
                    <div style="color: #00ff00; background: #000; padding: 10px; font-family: 'Courier New';">
                        <h3 style="margin: 0 0 10px 0; text-shadow: 0 0 5px #00ff00;">${point.title}</h3>
                        <p style="margin: 5px 0;">${point.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                        <p style="margin: 5px 0; color: #00cc00;">–í–ª–∞–¥–µ–ª–µ—Ü: ${point.owner_display_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}</p>
                        <p style="margin: 5px 0; font-size: 0.8em; color: #006600;">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${lat.toFixed(4)}, ${lon.toFixed(4)}</p>
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                markers.push(marker);
            }
            
            console.log('Markers added:', markers.length);
        } catch (error) {
            console.error('Error loading points:', error);
            showAuthWarning();
        }
    }
    
    function showAuthWarning() {
        const warning = L.popup()
            .setLatLng([55.7558, 37.6173])
            .setContent(`
                <div style="color: #ff0000; background: #000; padding: 15px; font-family: 'Courier New'; text-align: center;">
                    <h3 style="margin: 0 0 10px 0; text-shadow: 0 0 5px #ff0000;">‚ö† –î–û–°–¢–£–ü –û–ì–†–ê–ù–ò–ß–ï–ù ‚ö†</h3>
                    <p style="margin: 10px 0;">–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç–æ—á–µ–∫ –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</p>
                    <p style="margin: 10px 0; font-size: 0.9em;">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è JWT —Ç–æ–∫–µ–Ω–∞:</p>
                    <code style="display: block; background: #111; padding: 5px; margin: 5px 0; font-size: 0.8em;">
                        POST /api/auth/login/
                    </code>
                    <p style="margin: 10px 0; font-size: 0.8em;">–ó–∞—Ç–µ–º —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ç–æ–∫–µ–Ω –≤ localStorage:</p>
                    <code style="display: block; background: #111; padding: 5px; margin: 5px 0; font-size: 0.8em;">
                        localStorage.setItem('access_token', '–≤–∞—à_—Ç–æ–∫–µ–Ω')
                    </code>
                </div>
            `)
            .openOn(map);
    }

    function getCurrentLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    document.getElementById('search-lat').value = lat;
                    document.getElementById('search-lon').value = lon;
                    
                    if (userMarker) {
                        map.removeLayer(userMarker);
                    }
                    
                    userMarker = L.marker([lat, lon], {
                        icon: L.icon({
                            iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCAzMCA0MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTUgMEMxMC4wMyAwIDYgNC4wMyA2IDlDNiAxNC4yNSAxNSAyNSAxNSAyNUMxNSAyNSAyNCAxNC4yNSAyNCA5QzI0IDQuMDMgMTkuOTcgMCAxNSAwWiIgZmlsbD0iI2ZmMDAwMCIgc3Ryb2tlPSIjODgwMDAwIiBzdHJva2Utd2lkdGg9IjIiLz48Y2lyY2xlIGN4PSIxNSIgY3k9IjkiIHI9IjQiIGZpbGw9IiM4ODAwMDAiLz48L3N2Zz4=',
                            iconSize: [30, 40],
                            iconAnchor: [15, 40]
                        })
                    }).addTo(map);
                    
                    userMarker.bindPopup('<b style="color: #ff0000;">–í–´ –ó–î–ï–°–¨</b>').openPopup();
                    map.setView([lat, lon], 13);
                },
                (error) => {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ');
                }
            );
        } else {
            alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
        }
    }

    async function searchPoints() {
        const token = localStorage.getItem('access_token');
        if (!token) {
            alert('‚ö† –î–ª—è –ø–æ–∏—Å–∫–∞ —Ç–æ—á–µ–∫ –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');
            return;
        }
        
        const lat = document.getElementById('search-lat').value;
        const lon = document.getElementById('search-lon').value;
        const radius = document.getElementById('search-radius').value;

        if (!lat || !lon || !radius) {
            alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
            return;
        }

        if (searchCircle) {
            map.removeLayer(searchCircle);
        }
        
        searchCircle = L.circle([lat, lon], {
            color: '#00ff00',
            fillColor: '#00ff00',
            fillOpacity: 0.1,
            radius: radius * 1000
        }).addTo(map);
        
        map.setView([lat, lon], 12);

        try {
            const response = await fetch(
                `/api/points/search/?latitude=${lat}&longitude=${lon}&radius=${radius}`,
                {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                }
            );
            
            if (response.status === 401) {
                alert('‚ö† –¢–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏—Å—Ç–µ–∫. –ü–æ–ª—É—á–∏—Ç–µ –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω.');
                return;
            }
            
            const points = await response.json();
            
            if (!Array.isArray(points)) {
                console.error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ–∏—Å–∫–∞:', points);
                alert('‚ö† –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ —Ç–æ—á–µ–∫');
                return;
            }
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `<h3 style="color: #00ff00; text-shadow: 0 0 10px #00ff00;">‚ö° –ù–∞–π–¥–µ–Ω–æ —Ç–æ—á–µ–∫: ${points.length} ‚ö°</h3>`;
            
            points.forEach(point => {
                const [plon, plat] = point.location.coordinates;
                resultsDiv.innerHTML += `
                    <div class="point-card" onclick="map.setView([${plat}, ${plon}], 15);">
                        <h3>${point.title}</h3>
                        <p>${point.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                        <p>–í–ª–∞–¥–µ–ª–µ—Ü: ${point.owner_display_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}</p>
                        <p style="font-size: 0.8em; color: #006600;">–ö–ª–∏–∫ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –Ω–∞ –∫–∞—Ä—Ç–µ</p>
                    </div>
                `;
            });
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
            alert('‚ö† –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ —Ç–æ—á–µ–∫');
        }
    }

    loadPoints();
</script>
{% endblock %}
