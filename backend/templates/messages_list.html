{% extends 'base.html' %}

{% block title %}–°–æ–æ–±—â–µ–Ω–∏—è –ü—É—Å—Ç–æ—à–µ–π{% endblock %}

{% block content %}
<h2 style="text-align: center; margin-bottom: 20px;">üí¨ –°–û–û–ë–©–ï–ù–ò–Ø –í–´–ñ–ò–í–®–ò–• üí¨</h2>

<div id="messages-list">
    <p style="text-align: center; color: #00ff00;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</p>
</div>

<div style="text-align: center; margin-top: 20px;">
    <button class="btn" id="prev-btn" onclick="loadPage(currentPage - 1)">‚óÑ –ù–ê–ó–ê–î</button>
    <span id="page-info" style="margin: 0 20px; color: #00ff00;"></span>
    <button class="btn" id="next-btn" onclick="loadPage(currentPage + 1)">–í–ü–ï–†–ï–î ‚ñ∫</button>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentPage = 1;
    let totalPages = 1;

    async function loadPage(page) {
        try {
            const response = await fetch(`/api/points/messages/?page=${page}`, {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                }
            });
            const data = await response.json();
            
            currentPage = page;
            totalPages = Math.ceil(data.count / 20);
            
            const list = document.getElementById('messages-list');
            list.innerHTML = '';
            
            data.results.forEach(msg => {
                list.innerHTML += `
                    <div class="message-card">
                        <h4>${msg.user_display_name || '–ê–Ω–æ–Ω–∏–º'}</h4>
                        ${msg.user_avatar ? `<img src="${msg.user_avatar}" class="avatar" alt="Avatar">` : ''}
                        <p>${msg.text}</p>
                        ${msg.image ? `<img src="${msg.image}" style="max-width: 100%; margin-top: 10px; border: 1px solid #00ff00;">` : ''}
                        ${msg.file ? `<p><a href="${msg.file}" class="btn" download>üìé –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª</a></p>` : ''}
                        <p style="font-size: 0.8em; color: #006600; margin-top: 10px;">
                            –¢–æ—á–∫–∞ ID: ${msg.point} | ${new Date(msg.created_at).toLocaleString('ru-RU')}
                        </p>
                    </div>
                `;
            });
            
            document.getElementById('page-info').textContent = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage} –∏–∑ ${totalPages}`;
            document.getElementById('prev-btn').disabled = currentPage === 1;
            document.getElementById('next-btn').disabled = currentPage === totalPages;
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
            document.getElementById('messages-list').innerHTML = '<p style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</p>';
        }
    }

    loadPage(1);
</script>
{% endblock %}
